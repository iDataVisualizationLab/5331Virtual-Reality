<!DOCTYPE html>
<meta charset="utf-8">
<style> /* set the CSS */

body { font: 15px Arial;}

path { 
    fill: none;
}
.axis path,
.axis line {
    fill: none;
    stroke: grey;
    stroke-width: 1;
    shape-rendering: crispEdges;
}
#controlHolder {
  position:absolute;
  z-index: 0;
  top: 100px;
  left: 127px;
  border: 0px solid rgba(0,0,0, 1);
  background-color: none;
}

#searchHolder {
  position:absolute;
  z-index: 0;
  top: 15px;
  left: 427px;
  border: 0px solid rgba(0,0,0, 1);
  background-color: none;
}

#networkHolder {
    position:absolute;
    z-index: 0;
    top: 0px;
    left: 820px;
    border: 0px solid rgba(255,0,0, 1);
    background-color: rgba(0,0,255, 0.2);
    border-radius: 6px;
}

/* tooltip */
.d3-tip {
  line-height: 1;
  padding: 10px;
  font-size: 14px;
  font-family: "sans-serif";
  background: rgba(204, 204, 204, 0.96);
  color: #000;
  border: 1px solid rgba(0,0,0, 1);
  border-radius: 12px;
}

/* Style northward tooltips differently */
.d3-tip.n:after {
  margin: -1px 0 0 0;
  top: 100%;
  left: 0;
}

table, th, td {
    border: 1px solid #ccc;
    border-collapse: collapse;
    padding: 2px;
    background-color: #fff;
}

#graph {
    width: 900px;
    height: 500px;
}
</style>
<body bgcolor="white" text="black" id="mainBody">
<svg width="2100" height="700"></svg>

<div id="searchHolder"  class="searchHolder">
  <input id="search">
  <button type="button" onclick="searchNode()">Search</button>
  <progress value="0" max="100" id="progBar">
      <span id="downloadProgress">
          <!-- Your fallback goes here -->
      </span>
  </progress>
  <label id="progUpdate">
      <!-- Success Message -->
  </label>
</div> 

<div id="controlHolder"  class="controlHolder">
 <input type="checkbox" id="checkboxP1" visibility="hidden" value="value2" class="check" onclick="check1()">
<label for="checkbox1"> Order by deadline</label>
</div>

<div id="networkHolder"  class="networkHolder">
</div>

<div id="graph"></div>
<!-- load the d3.js library -->    
<script src="js/jquery.min.js"></script>
<script type='text/javascript' src="js/jquery-ui.min.js"> </script>
<script src="js/d3.v4.js"></script>
<script src="js/d3.tip.js"></script>
<link href="jquery-ui.css" rel="stylesheet" type="text/css" />

<script>


// Set the dimensions of the canvas / graph
var margin = {top: 5, right: 30, bottom: 50, left: 70};

var svg = d3.select("svg"),
    width = +document.getElementById("mainBody").offsetWidth-margin.left-margin.right,
    height = +svg.attr("height")-margin.top-margin.bottom;

svg = svg.append("g")
        .attr("transform", 
              "translate(" + margin.left + "," + margin.top + ")");

var w2 =500;
var h2 =450;
var svg2 = d3.select("#networkHolder").append("svg")
    .attr("width", w2)
    .attr("height", h2);

// Parse the date / time
var parseTime = d3.timeParse("%m/%d/%y");

// Set the ranges
var x = d3.scaleTime().range([0, width-margin.left*2]);
var xNew = d3.scaleTime().range([0, width/2-margin.left]);

var y = d3.scaleLinear().range([height, 0]);
var yAxis= d3.scaleLinear().range([height, 0]);


// Student info data  
var data2 = {};
var dataG = {};
var groupCount = [{},{},{},{}];
d3.csv("data/Students.csv", function(error, data_) {
  d3.csv("data/ResearchInsights.csv", function(error, dataG_) {
    dataG = dataG_;
    main();
  })  
})

// Force-directed layout
var simulation = d3.forceSimulation()
    .force("link", d3.forceLink().id(function(d) { return d.id; }))
    .force("link", d3.forceLink().distance(1).strength(1))
    .force("charge", d3.forceManyBody().strength(-0.1));

var simulation2 = d3.forceSimulation()
    .force("link", d3.forceLink().id(function(d) { return d.id; }))
    .force("center", d3.forceCenter().x(w2/2).y(h2/2))
    .force("charge", d3.forceManyBody().strength(-1.4));

var getColor = d3.scaleOrdinal(d3.schemeCategory20);

var radius = 8;

var node, link;
var node2, link2;
var linkArcs;

var dur = 400;  // animation duration

// Force-directed layout
var nodes=[];
var links=[];
var nodes2=[];
var links2=[];

var startDate = new Date("4/1/2018");
var endtDate = new Date("1/1/2019");
var today = new Date();
    
function getCategoty(str){
  if (str=="PhD")
    return 3;
  else if (str=="MSSE")
    return 2;
  else if (str=="MSCS")
    return 1;
  else 
    return 0; 
}
var data = {};

var sponsorlist = [];
var maxSponsor =83;
function getGrantName(name){
  for(var i = 0; i < maxSponsor; i++) {
    if (sponsorlist[i].name == name) {
        return name;
    }
  }
  return "Others";
}
var radiusScale ; // Radius scale, defined later
       

function main(){
  // Scale the range of the data
  x.domain([startDate,endtDate]);
  xNew.domain([startDate,endtDate]);
  y.domain([0, 15]);
  yAxis.domain([0, 0.15]);
  
  // Draw color legend *************************
  svg.append("line")
    .attr("class", "legendLine10")
    .attr("stroke", "#000")
    .attr("stroke-width", 1)
    .style("stroke-dasharray", ("2, 2"))
    .attr("x1", x(today))
    .attr("y1", y(10))
    .attr("x2", x(today))
    .attr("y2", height);
   svg.append("text")
      .attr("class", "title")
      .style("font-size", "14px")
      .attr("text-anchor", "left")
      .attr("fill", "#666")
      .attr("x", x(today))
      .attr("y", y(10))
      .text("Today");
    
    
    // Draw title *******************************
     svg.append("text")
      .attr("class", "title")
      .style("font-size", "20px")
      .attr("text-anchor", "left")
      .attr("fill", "#000")
      .attr("x", margin.left)
      .attr("y", 20)
      .text("Related research grants");
    
    // Draw Label for yAxis *******************************
     svg.append("text")
      .attr("class", "title")
      .style("font-size", "17px")
      .attr("text-anchor", "middle")
      .attr("fill", "#000")
      .attr("x", width/2-100)
      .attr("y", height+40)
      .text("Date");
    
    
      // Add the x Axis
      svg.append("g")
        .attr("class", "xAxis")
        .style("font-size", "14px")
        .attr("transform", "translate(0," + height + ")")
        .call(d3.axisBottom(x));

      // Add the y Axis
     // svg.append("g")
     //   .style("font-size", "14px")
     //   .call(d3.axisLeft(yAxis).ticks(12));
    dataG.sort(function(a,b){
        if (new Date(a.Deadline)<new Date(b.Deadline)){
            return -1;
        }
        else
            return 1;
    })

    var minAmount= +dataG[0].Amount;
    var maxAmount= +dataG[0].Amount;
    for (var i=0; i<dataG.length;i++){
      dataG[i].Amount = +dataG[i].Amount;

      var nod1 = {};
      nod1.name = dataG[i].Title;
      nod1.Amount = dataG[i].Amount;
      nod1.Sponsors = dataG[i].Sponsors;
      nod1.Link = dataG[i].Link;
      nod1.Deadline = new Date(dataG[i].Deadline);
      nod1.originalOrder = nodes.length;
      nodes.push(nod1);

      var nod2 = {};
      nod2.name = dataG[i].Title;
      nod2.Amount = dataG[i].Amount;
      nod2.Deadline = new Date(dataG[i].Deadline);
      nod2.Link = dataG[i].Link;
      nod2.Sponsors = dataG[i].Sponsors;
      nod2.SponsorList = dataG[i].Sponsors.split(", ");
      nod2.originalOrder = nodes.length;
      nodes.push(nod2);

      // Compute min and max amount
      if (dataG[i].Amount<minAmount)
        minAMount = dataG[i].Amount;
      if (dataG[i].Amount>maxAmount)
        maxAmount = dataG[i].Amount;

      var lin = {};
      lin.source = nod1;
      lin.target = nod2;
      lin.group = nod1.group;
      links.push(lin);
    }

    function isContainObject(array, name) {
        var found = false;
        for(var i = 0; i < array.length; i++) {
            if (array[i].name == name) {
                found = true;
                break;
            }
        }
        return found;
    }
    // Compute Sponsors list
    var indexOfsponsorlist = {};
    for (var i=0; i<dataG.length;i++) {
        var list = dataG[i].Sponsors.split(", ");
        for (var j = 0; j < list.length; j++) {
            if (isContainObject(sponsorlist,list[j])==false){
                var obj = {};
                obj.name = list[j];
                obj.Amount = 0;   // initialize the amount of money
                sponsorlist.push(obj);
                indexOfsponsorlist[obj.name] = sponsorlist.length-1;
            }
        }
    }

    // Compute Sponsors Money
    for (var i=0; i<dataG.length;i++) {
        var list = dataG[i].Sponsors.split(", ");
        if (list.length>0){
            var money = dataG[i].Amount/list.length;
            for (var k = 0; k < list.length; k++) {
                var index =  indexOfsponsorlist[list[k]];
                sponsorlist[index].Amount += money;
            }
        }
    }
    // Compute Co-Sponsors list
    var cosponsorArray = new Array(sponsorlist.length);
    for (var j = 0; j < sponsorlist.length; j++) {
        cosponsorArray[j] = new Array(sponsorlist.length);
    }
    for (var j = 0; j < sponsorlist.length; j++) {
      for (var k = 0; k < sponsorlist.length; k++) {
        cosponsorArray[j][k] =0;
      }  
    }  

    for (var i=0; i<dataG.length;i++) {
      var list = dataG[i].Sponsors.split(", ");
      for (var j = 0; j < list.length; j++) {
        for (var k = j+1; k < list.length; k++) {
          var indexJ = indexOfsponsorlist[list[j]]
          var indexK = indexOfsponsorlist[list[k]]
          if (indexJ<indexK)
            cosponsorArray[indexJ][indexK] ++;
          if (indexJ>indexK)
            cosponsorArray[indexK][indexJ] ++;
        }  
      }
    }

    // Second network
    for (var i=0; i<sponsorlist.length;i++){
      var nod1 = {};
      nod1.name = sponsorlist[i].name;
      nod1.Amount = sponsorlist[i].Amount;
      nodes2.push(nod1);
    }

    for (var j = 0; j < sponsorlist.length; j++) {
      for (var k = j+1; k < sponsorlist.length; k++) {
        if (cosponsorArray[j][k]>0){
           var lin = {};
          lin.source = nodes2[j];
          lin.target = nodes2[k];
          lin.count = cosponsorArray[j][k];
          links2.push(lin);
        }
      }  
    }     
    // Search student nickname
    var optArray =[];
    for (var i=0; i<dataG.length;i++){
       optArray.push(dataG[i].Title);
    }

    optArray = optArray.sort();
    $(function () {
        $("#search").autocomplete({
            source: optArray
        });
    });
    
    link = svg.selectAll(".links")
      .data(links)
      .enter().append("line")
        .attr("class", "links")
        .attr("stroke", function(d){
          return "#000";
        })
        .attr("stroke-opacity", 0.02)
        .attr("stroke-width",0.5);
         
  radiusScale = d3.scaleLinear().range([7, 25]).domain([Math.sqrt(minAmount),Math.sqrt(maxAmount)]) ;


  sponsorlist = sponsorlist.sort(function(a,b){
    if (a.name=="None")
      return 1;
    if (a.Amount>b.Amount){
      return -1;
    }
    else return 1;
  })

  node = svg.selectAll(".nodeCircle")
        .data(nodes)
        .enter().append("circle")
          .attr("class","nodeCircle")
          .attr("r", getRadius)
          .attr("fill", function(d,i) { 
            if (i%2==0)
              return "#000"; 
            else{
              return getColor(getGrantName(d.SponsorList[0])); 
            }
        })
        .attr("fill-opacity", function(d){
          if (d.Deadline<today)
            return 0.1;
          else
            return 1;
        })  
        .attr("stroke", "#fff")
        .attr("stroke-weight", 0.5)  
        .on("mouseover", mouseoverNode)
        .on("mouseout", mouseoutNode)
        .on("click", function(d){
          window.open(d.Link,'_blank')
        })
        .call(d3.drag()
            .on("start", dragstarted)
            .on("drag", dragged)
            .on("end", dragended));




    linkArcs = svg.append("g").selectAll("path")
        .data(nodes)
        .enter().append("path")
        .attr("class", "linkArc")
        .style("stroke", "#000")
        .style("stroke-width", 1);

    var arc = d3.arc()
        .innerRadius(3)
        .startAngle(45 * (Math.PI/180)) //converting from degs to radians
        .endAngle(3) //just radians

    var pie = d3.pie()
        .sort(null)
        .value(function (d) {
            return d.value;
        });
    linkArcs.selectAll(".aaaa").remove();

    linkArcs.selectAll(".aaaa").data(function (d) {
        var list = d.Sponsors.split(", ");
        if (list.length>0){
            var money = d.Amount/list.length;
            d.valueList = [];
            for (var k = 0; k < list.length; k++) {
                obj = {};
                obj.value = money;
                d.valueList.push(obj);
            }
        }
        console.log(pie(d.valueList));
        return pie(d.valueList);
    })
        .enter().append("circle")
        .attr("class","aaaa")
        //.attr("d", function(d) {
        //    arc.outerRadius(getRadius(d));
        //    return arc(d);
        //})
        .attr("r", 100)
        .attr("cx", 100)
        .attr("cy", 100)
        .style("fill", "#f00");



    link2 = svg2.selectAll(".links")
      .data(links2)
      .enter().append("line")
        .attr("class", "links")
        .attr("stroke", function(d){
          return "#000";
        })
        .attr("stroke-width",0.5); 
  node2 = svg2.selectAll(".nodeCircle")
      .data(nodes2)
      .enter().append("circle")
        .attr("class","nodeCircle")
        .attr("r", function(d){
          return radiusScale(Math.sqrt(d.Amount));
        })
        .attr("fill", function(d,i) { 
            return getColor(getGrantName(d.name));
      })
      .attr("stroke", "#fff")
      .attr("stroke-weight", 0.5)  
      .on("mouseover", mouseoverNode)
      .on("mouseout", mouseoutNode)
      .on("click", function(d){
        window.open(d.Link,'_blank')
      })
      .call(d3.drag()
          .on("start", dragstarted2)
          .on("drag", dragged2)
          .on("end", dragended2));               

  simulation
      .nodes(nodes)
      .on("tick", ticked);
    simulation.force("link")
        .links(links);
    simulation.force("collide", d3.forceCollide(getRadius));  
    
  simulation2
      .nodes(nodes2)
      .on("tick", ticked2);
  simulation2.force("link")
        .links(links2);
  simulation2.force("collide", d3.forceCollide(function(d){
    return getRadius(d)+1;
  }));  
  
}

function getRadius(d,i){
    if (i%2==0)
        return 0;
    else
        return radiusScale(Math.sqrt(d.Amount));
}

function ticked() {
      if (document.getElementById("checkboxP1").checked) {
          var startY = 210;
          for (var i=0;i<nodes.length;i=i+2){
              nodes[i].x = x(nodes[i].Deadline);

              if (i==0){
                  nodes[i].y =startY;
              }
              else {
                  nodes[i].y = startY+i*3;
              }

          }
      }
      else{

          for (var i=0;i<nodes.length;i=i+2){
              nodes[i].x = x(nodes[i].Deadline);
              nodes[i].y = height-100;
          }
      }






    linkArcs.attr("transform", function (d) {
        return "translate(" + d.x + "," + d.y + ")";
    });

      link
        .attr("x1", function(d) { return d.source.x; })
        .attr("y1", function(d) { return d.source.y; })
        .attr("x2", function(d) { return d.target.x; })
        .attr("y2", function(d) { return d.target.y; });
    node
        .attr("cx", function(d) { return d.x; })
        .attr("cy", function(d) { return d.y; });
  }

  function ticked2() {
    link2
        .attr("x1", function(d) { return d.source.x; })
        .attr("y1", function(d) { return d.source.y; })
        .attr("x2", function(d) { return d.target.x; })
        .attr("y2", function(d) { return d.target.y; });
    node2
        .attr("cx", function(d) { return d.x; })
        .attr("cy", function(d) { return d.y; });
  }




function searchNode() {
    //searchTerm = document.getElementById('search').value;
    var value = document.getElementById('search').value;
    svg.selectAll(".nodeCircle")
        .transition().duration(dur*4)
        .attr("r", function (d,i){
          if (i%2==0)
            return 0;
          if (d.name.toLowerCase().indexOf(value.toLowerCase())>=0)
            return radiusScale(Math.sqrt(d.Amount));
          else
            return 0;
         });
}

function check1() {
    simulation.stop();
    simulation.alphaTarget(0.03).restart();
}


function mouseoverNode(d1){
    tool_tip.show(d1);
    svg.selectAll(".nodeCircle")
        .transition().duration(dur)
        .attr("stroke-opacity", function (d2){
            //  if (!document.getElementById("checkboxP1").checked) return 0;
            return d1.name==d2.name ? 1 : 0.05; })
        .attr("fill-opacity", function (d2){
            return d1.name==d2.name ? 1 : 0.1; });

        svg.selectAll(".links")
        .transition().duration(dur)
        .attr("stroke-opacity", function (d2){ return d1.name==d2.source.name ? 1 : 0.1; });
      svg.selectAll(".links01")  
        .transition().duration(dur)
        .attr("stroke-opacity", function (d2){ 
          if (!document.getElementById("checkboxP1").checked) return 0;
          return d1.name==d2.source.name ? 1 : 0.1; }); 
    }

    function mouseoutNode(d1){
       tool_tip.hide(d1);

       svg.selectAll(".nodeCircle")
        .transition().duration(dur)
        .attr("stroke-opacity", 1)
        .attr("fill-opacity", function(d){
          if (d.Deadline<today)
            return 0.1;
          else
            return 1;
        });

      
      //svg.selectAll(".links")  
      //  .transition().duration(dur)
      //  .attr("stroke-opacity", 1);
      
    }

    function mouseoverLegend(d1){
        /*svg.selectAll(".legendText")
          .attr("fill-opacity", function (d2){
           return d1.program==d2.program ? 1 : 0.1; });
        svg.selectAll(".legendLine")
          .attr("stroke-opacity", function (d2){
           return d1.program==d2.program ? 1 : 0.1; });
        svg.selectAll(".legendCircle")
          .attr("fill-opacity", function (d2){
           return d1.program==d2.program ? 1 : 0.1; });
        svg.selectAll(".lineGraph")
          .transition().duration(dur)
          .attr("stroke-opacity", function (d2){
           return getCategoty(d1.program)==d2.group ? 1 : 0.05; });
        svg.selectAll(".nodeImage")
          .transition().duration(dur)
          .attr("stroke-opacity", function (d2){ 
            return getCategoty(d1.program)==d2.group ? 1 : 0.05; })
          .attr("fill-opacity", function (d2){ 
            return getCategoty(d1.program)==d2.group ? 1 : 0.1; });   
        svg.selectAll(".nodeImageP1")
          .transition().duration(dur)
          .attr("stroke-opacity", function (d2){ 
            if (!document.getElementById("checkboxP1").checked) return 0;
            return getCategoty(d1.program)==d2.group ? 1 : 0.05; })
          .attr("fill-opacity", function (d2){ 
            if (!document.getElementById("checkboxP1").checked) return 0;
            return getCategoty(d1.program)==d2.group ? 1 : 0.1; });   
        svg.selectAll(".nodeCircle")  
          .transition().duration(dur)
          .attr("fill-opacity", function (d2){ 
            return getCategoty(d1.program)==d2.group ? 1 : 0.1; });   
        
        svg.selectAll(".links")  
          .transition().duration(dur)
          .attr("stroke-opacity", function (d2){ return getCategoty(d1.program)==d2.source.group ? 1 : 0.1; });
        svg.selectAll(".linksP1")  
          .transition().duration(dur)
          .attr("stroke-opacity", function (d2){ return getCategoty(d1.program)==d2.source.group ? 1 : 0.1; });
        svg.selectAll(".links01")
          .transition().duration(dur)
          .attr("stroke-opacity", function (d2){ return getCategoty(d1.program)==d2.source.group ? 1 : 0.1; });
        svg.selectAll(".linksP2")  
          .transition().duration(dur)
          .attr("stroke-opacity", function (d2){ return getCategoty(d1.program)==d2.source.group ? 1 : 0.1; });
        svg.selectAll(".links02")
          .transition().duration(dur)
          .attr("stroke-opacity", function (d2){ return getCategoty(d1.program)==d2.source.group ? 1 : 0.1; });
        svg.selectAll(".linksP3")  
          .transition().duration(dur)
          .attr("stroke-opacity", function (d2){ return getCategoty(d1.program)==d2.source.group ? 1 : 0.1; });
        svg.selectAll(".links03")
          .transition().duration(dur)
          .attr("stroke-opacity", function (d2){ return getCategoty(d1.program)==d2.source.group ? 1 : 0.1; });*/
     
    }  
    function mouseoutLegend(d1){
      svg.selectAll(".legendText")
          .attr("fill-opacity", 1);
        svg.selectAll(".legendLine")
          .attr("stroke-opacity", 1);
        svg.selectAll(".legendCircle")
          .attr("fill-opacity", 1);
        svg.selectAll(".lineGraph")
          .transition().duration(dur)
          .attr("stroke-opacity", 1);
        svg.selectAll(".nodeImage")
          .transition().duration(dur)
          .attr("stroke-opacity", 1)
          .attr("fill-opacity", 1);   
        svg.selectAll(".links")  
          .transition().duration(dur)
          .attr("stroke-opacity", 1); 
        svg.selectAll(".nodeCircle")  
          .transition().duration(dur)
          .attr("fill-opacity", 1);  
          
    }



function dragstarted(d) {
  if (!d3.event.active) simulation.alphaTarget(0.3).restart();
  d.fx = d.x;
  d.fy = d.y;
}

function dragged(d) {
  d.fx = d3.event.x;
  d.fy = d3.event.y;
}

function dragended(d) {
  if (!d3.event.active) simulation.alphaTarget(0);
  d.fx = null;
  d.fy = null;
}

function dragstarted2(d) {
  if (!d3.event.active) simulation2.alphaTarget(0.3).restart();
  d.fx = d.x;
  d.fy = d.y;
}

function dragged2(d) {
  d.fx = d3.event.x;
  d.fy = d3.event.y;
}

function dragended2(d) {
  if (!d3.event.active) simulation2.alphaTarget(0);
  d.fx = null;
  d.fy = null;
}

</script>
<script src="myscripts/tooltip.js"></script>

</body>